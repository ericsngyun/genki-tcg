================================================================================
GENKI TCG API - VULNERABILITY QUICK REFERENCE MATRIX
================================================================================

CRITICAL ISSUES (5):
====================

1. IDOR - MISSING ORGANIZATION VALIDATION
   Endpoints:
   - GET /events/:id                      (events.controller.ts:19)
   - PATCH /events/:id                    (events.controller.ts:33)
   - GET /standings/events/:eventId       (standings.controller.ts:13)
   - GET /rounds/:roundId/pairings        (rounds.controller.ts:19)
   - GET /matches/:id                     (matches.controller.ts:20)
   
   Issue: Resources queried by ID only, no orgId verification
   Impact: Any user can read/modify any event, round, or match across orgs
   Fix: Add orgId parameter to all service methods and filter by orgId

2. NO RUNTIME INPUT VALIDATION
   All DTOs are TypeScript interfaces (not classes):
   - SignupDto (auth.service.ts:12)
   - LoginDto (auth.service.ts:19)
   - CreateEventDto (events.service.ts:5)
   - UpdateEventDto (events.service.ts:17)
   - CreditAdjustDto (credits.service.ts:6)
   - SubmitDecklistDto (decklists.service.ts:4)
   - ReportMatchResultDto (matches.service.ts:6)
   
   Issue: ValidationPipe configured but can't validate interfaces
   Impact: Negative amounts, invalid types, missing fields all accepted
   Fix: Convert all interfaces to class-based DTOs with validators

3. PAYMENT BYPASS
   Endpoint: POST /events/entries/:entryId/mark-paid
   Issue: Staff can mark payment for any amount, including $0
   Impact: Entry fee requirement bypassed completely
   Fix: Validate amount matches event.entryFeeCents exactly

4. PRIZE MANIPULATION
   Endpoint: POST /events/:id/distribute-prizes
   Issues:
   - No validation total amount <= event.totalPrizeCredits
   - No validation user is in event
   - No validation amount is positive
   - Can distribute to non-participants
   Impact: Fraudulent prize distribution, credit manipulation
   Fix: Add comprehensive validation before distribution

5. RACE CONDITION IN PAYMENT MARKING
   Endpoint: POST /events/entries/:entryId/mark-paid
   Issue: Check and update not atomic, race condition between threads
   Impact: Same entry marked paid twice in concurrent requests
   Fix: Use database transaction or unique constraint


HIGH SEVERITY ISSUES (6):
=========================

6. MISSING ENTRY OWNERSHIP VALIDATION
   Endpoints:
   - POST /events/entries/:entryId/check-in (events.controller.ts:47)
   - POST /events/entries/:entryId/mark-paid (events.controller.ts:54)
   - POST /events/entries/:entryId/drop (events.controller.ts:83)
   
   Issue: Staff can modify any entry without verifying org ownership
   Fix: Add orgId validation to entry queries

7. MISSING EVENT OWNERSHIP IN ROUNDS
   Endpoint: POST /rounds/events/:eventId/next
   Issue: Staff can create rounds for events in other organizations
   Fix: Validate event belongs to user's org

8. MISSING MATCH OWNERSHIP
   Endpoints:
   - POST /matches/report (matches.controller.ts:13)
   - POST /matches/:id/override (matches.controller.ts:25)
   Issue: Staff can report/override results for matches in other orgs
   Fix: Validate match -> round -> event -> org chain

9. UNVALIDATED SEARCH PARAMETER
   Endpoint: GET /orgs/users
   Issue: search query parameter not validated for length/type
   Fix: Validate search is string and max 50 chars

10. MISSING VALIDATION IN DECKLISTS
    Endpoints:
    - POST /decklists/entry/:entryId/lock (decklists.controller.ts:43)
    - POST /decklists/event/:eventId/lock-all (decklists.controller.ts:50)
    Issue: No org ownership validation
    Fix: Add orgId parameter and verify ownership

11. CHECK-IN BYPASS VIA LATE ADD
    Endpoint: POST /events/:id/add-late-player
    Issue: Late adds auto-checked-in without payment verification
    Fix: Don't auto-check-in, require normal check-in workflow


MEDIUM SEVERITY ISSUES (3):
============================

12. UNTYPED DTOs IN SPECIFIC ENDPOINTS
    Endpoints:
    - POST /events/entries/:entryId/mark-paid (amount parameter)
    - POST /events/:id/distribute-prizes (distributions array)
    - POST /events/entries/:entryId/drop (currentRound parameter)
    - POST /matches/:id/override (result, gamesWonA, gamesWonB)
    Issue: Inline object types not validated
    Fix: Create proper DTO classes with validators

13. SENSITIVE DATA IN CSV EXPORT
    Endpoint: GET /standings/events/:eventId/export
    Issues:
    - No orgId validation (ANY org staff can export)
    - Exports player names (PII)
    - No rate limiting
    Fix: Add orgId validation, mask PII, add rate limits

14. WEAK MATCH RESULT VALIDATION
    Endpoint: POST /matches/report
    Issue: gamesWonA/gamesWonB not validated for reasonable bounds
    Fix: Add @Min/@Max validators for game count fields


================================================================================
ENDPOINT SECURITY CHECKLIST
================================================================================

Controller: auth.controller.ts
[ ] POST /auth/signup
    [~] Has ValidationPipe (but DTO is interface - no validation)
    [ ] Requires proper email validation
    [ ] Password strength validation needed

[ ] POST /auth/login
    [~] Has ValidationPipe (but DTO is interface - no validation)
    [✓] Uses bcrypt for password comparison
    [ ] Add rate limiting for failed attempts

[ ] GET /auth/me
    [✓] JwtAuthGuard present
    [✓] Returns sanitized user data


Controller: orgs.controller.ts
[ ] GET /orgs/me
    [✓] JwtAuthGuard present
    [✓] Returns user's org

[ ] GET /orgs/users
    [✓] JwtAuthGuard present
    [✗] search parameter NOT VALIDATED
    [✓] Filtered by orgId


Controller: events.controller.ts
[ ] GET /events
    [✓] JwtAuthGuard present
    [✓] Filtered by orgId
    [ ] Status parameter not validated

[ ] GET /events/:id
    [✓] JwtAuthGuard present
    [✗] NO orgId validation
    [✗] IDOR vulnerability

[ ] PATCH /events/:id
    [✓] RolesGuard + Roles('OWNER', 'STAFF')
    [✗] NO orgId validation
    [✗] IDOR vulnerability

[ ] POST /events
    [✓] RolesGuard + Roles
    [~] CreateEventDto uses interface (no validation)
    [✓] Uses user.orgId

[ ] POST /events/:id/register
    [✓] JwtAuthGuard present
    [ ] No validation event allows registration

[ ] POST /events/:id/self-check-in
    [✓] JwtAuthGuard present
    [ ] No payment validation (done in service)
    [ ] Should validate user is registered

[ ] POST /events/entries/:entryId/check-in
    [✓] RolesGuard + Roles
    [✗] NO entry ownership validation
    [✗] IDOR vulnerability

[ ] POST /events/entries/:entryId/mark-paid
    [✓] RolesGuard + Roles
    [✗] NO entry ownership validation
    [✗] Amount not validated (can be $0)
    [✗] Race condition possible
    [✗] IDOR vulnerability

[ ] POST /events/:id/add-late-player
    [✓] RolesGuard + Roles
    [✗] Auto-checks in without payment
    [✗] Check-in bypass vulnerability

[ ] POST /events/:id/distribute-prizes
    [✓] RolesGuard + Roles
    [✗] NO orgId validation
    [✗] NO validation of total amount
    [✗] NO validation users in event
    [✗] NO validation of amounts (can be negative)

[ ] POST /events/entries/:entryId/drop
    [✓] RolesGuard + Roles
    [✗] NO entry ownership validation
    [✗] IDOR vulnerability

[ ] GET /events/:id/my-matches
    [✓] JwtAuthGuard present
    [✓] Filtered by userId


Controller: rounds.controller.ts
[ ] POST /rounds/events/:eventId/next
    [✓] RolesGuard + Roles
    [✗] NO event ownership validation
    [✗] IDOR vulnerability

[ ] GET /rounds/:roundId/pairings
    [✓] JwtAuthGuard present
    [✗] NO event ownership validation
    [✗] IDOR vulnerability


Controller: matches.controller.ts
[ ] POST /matches/report
    [✓] RolesGuard + Roles
    [~] ReportMatchResultDto is interface (no validation)
    [✗] NO event ownership validation
    [ ] gamesWonA/gamesWonB not bounded

[ ] GET /matches/:id
    [✓] JwtAuthGuard present
    [✗] NO event ownership validation
    [✗] IDOR vulnerability

[ ] POST /matches/:id/override
    [✓] RolesGuard + Roles
    [✗] NO event ownership validation
    [✗] Inline DTO not validated
    [✗] IDOR vulnerability


Controller: standings.controller.ts
[ ] GET /standings/events/:eventId
    [✓] JwtAuthGuard present
    [✗] NO orgId validation
    [✗] IDOR vulnerability

[ ] GET /standings/events/:eventId/export
    [✓] RolesGuard + Roles
    [✗] NO orgId validation
    [✗] Exports PII (names)
    [✗] IDOR vulnerability


Controller: decklists.controller.ts
[ ] POST /decklists
    [✓] JwtAuthGuard present
    [~] SubmitDecklistDto is interface (no validation)
    [✓] Verified user owns entry in service

[ ] GET /decklists/entry/:entryId
    [✓] JwtAuthGuard present
    [✓] Verified user owns decklist in service

[ ] GET /decklists/event/:eventId
    [✓] RolesGuard + Roles
    [✗] NO event ownership validation
    [✗] IDOR vulnerability

[ ] POST /decklists/entry/:entryId/lock
    [✓] RolesGuard + Roles
    [✗] NO entry/event ownership validation
    [✗] IDOR vulnerability

[ ] POST /decklists/event/:eventId/lock-all
    [✓] RolesGuard + Roles
    [✗] NO event ownership validation
    [✗] IDOR vulnerability


Controller: credits.controller.ts
[ ] GET /credits/me
    [✓] JwtAuthGuard present
    [✓] Returns user's balance only
    [✓] Validated user in org

[ ] GET /credits/balance/:userId
    [✓] RolesGuard + Roles
    [✓] Validated user in org

[ ] GET /credits/history/:userId
    [✓] RolesGuard + Roles
    [✓] Validated user in org

[ ] POST /credits/adjust
    [✓] RolesGuard + Roles
    [~] CreditAdjustDto is interface (no validation)
    [✓] Validated user in org
    [ ] Amount not bounded (could be massive)

[ ] POST /credits/redeem
    [✓] RolesGuard + Roles
    [~] Untyped body (userId, amount)
    [✓] Validated user in org
    [ ] Amount not validated

[ ] POST /credits/reconcile/:userId
    [✓] RolesGuard + Roles (OWNER only)
    [✓] Validated user in org


================================================================================
SUMMARY
================================================================================

Total Vulnerabilities: 14
- Critical: 5 (5 distinct issues affecting multiple endpoints)
- High:     6 (6 distinct issues)
- Medium:   3 (3 distinct issues)

Most Critical Fixes Needed:
1. Convert ALL interfaces to class-based DTOs with validation
2. Add orgId checks to ALL service methods
3. Fix payment marking (validate amount, prevent race conditions)
4. Fix prize distribution (validate total, users, amounts)
5. Add entry ownership validation to staff endpoints

Affected Endpoint Count:
- 28 total endpoints in scope
- 17 endpoints with CRITICAL or HIGH severity issues
- 11 endpoints with authorization/IDOR vulnerabilities

